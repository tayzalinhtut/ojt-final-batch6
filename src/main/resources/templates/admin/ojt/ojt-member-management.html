<!DOCTYPE html>
<html lang="en" xmlns="http://www.thymeleaf.org">

<head th:replace="fragment/header :: header"></head>

<body class="bg-light">
	<div class="d-flex">
		<!-- Sidebar -->
		<div th:replace="fragment/side-bar :: side-bar"></div>

		<!-- Main Content -->
		<div class="flex-grow-1" style="margin-left: 280px">
			<!-- Top Navigation -->
			<header class="bg-white shadow-sm border-bottom sticky-top">
				<div class="d-flex align-items-center justify-content-between p-4">
					<div class="d-flex align-items-center">
						<h3 class="mb-0 fw-bold text-dark">OJT Management</h3>
					</div>
					<div class="d-flex align-items-center gap-3">
						<div class="dropdown">
							<button class="btn btn-link text-muted p-2 position-relative" data-bs-toggle="dropdown">
								<i class="bi bi-bell fs-5"></i>
								<span
									class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
									style="font-size: 0.6rem">3</span>
							</button>
							<ul class="dropdown-menu dropdown-menu-end">
								<li><a class="dropdown-item" href="#">New evaluation pending</a></li>
								<li><a class="dropdown-item" href="#">Interview scheduled</a></li>
								<li><a class="dropdown-item" href="#">Offer response due</a></li>
							</ul>
						</div>
					</div>
				</div>
			</header>

			<!-- Members Content -->
			<div class="p-4">
				<!-- Filter UI can be added here -->

				<!-- Members Table Card -->
				<div class="card border-0 shadow-sm">
					<div
						class="card-header bg-white border-bottom d-flex align-items-center justify-content-between py-3">
						<h5 class="fw-bold mb-0">Member Directory</h5>
					</div>
					<div class="card-body p-0">
						<div class="table-responsive">
							<table class="table table-hover mb-0">
								<thead class="bg-light">
									<tr>
										<th class="border-0 fw-semibold py-3 px-4">Member</th>
										<th class="border-0 fw-semibold py-3">OJT Batch</th>
										<th class="border-0 fw-semibold py-3">Attendance</th>
										<th class="border-0 fw-semibold py-3">Status</th>
										<th class="border-0 fw-semibold py-3">Actions</th>
									</tr>
								</thead>
								<tbody id="ojtTableBody">
									<!-- rows injected by JS -->
								</tbody>
							</table>
						</div>
					</div>
					<div class="card-footer bg-light border-top d-flex align-items-center justify-content-between py-3">
						<div class="text-muted">
							Showing <span id="startEntry">1</span> to <span id="endEntry">5</span> of
							<span id="totalEntries">0</span> entries
						</div>
						<nav aria-label="Page navigation">
							<ul class="pagination pagination-sm mb-0" id="pagination">
								<li class="page-item" id="prevPage">
									<a class="page-link" href="#">Previous</a>
								</li>
								<!-- Page numbers injected here -->
								<li class="page-item" id="nextPage">
									<a class="page-link" href="#">Next</a>
								</li>
							</ul>
						</nav>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

		<script th:inline="javascript">
		/*<![CDATA[*/
		    let message = /*[[${message != null ? "" + message + "" : ""}]]*/ '';
			const notyf = new Notyf();
		    console.log("Flash message: " + message);

		    if (message.trim().length > 0) {
				notyf.success({
					message: message,
					duration: 5000,
					position: {
						x: 'right',
						y: 'top'
					}
				})
		    }
			
			let errorMessage = /*[[${errorMessage != null ? "" + errorMessage + "" : ""}]]*/ '';

			if (errorMessage.trim().length > 0) {
			    notyf.error({
			        message: errorMessage,
			        duration: 5000,
			        position: {
			            x: 'right',
			            y: 'top'
			        }
			    });
			}
		/*]]>*/
		</script>

	<script>
		const cache = {};
		let currentPage = 0;
		let totalPages = 1;
		const pageSize = 5;

		async function fetchPage(page) {
			if (cache[page]) {
				console.log(`Page ${page} from cache`);
				return cache[page];
			}
			console.log(`Fetching page ${page} from server`);
			const res = await fetch(`/admin/api/ojt-members?page=${page}`);
			console.log(res.ok);
			if (!res.ok) throw new Error("Failed to fetch");
			const data = await res.json();
			cache[page] = data;
			return data;
		}

		function renderTable(pageData) {
			const tbody = document.getElementById("ojtTableBody");
			tbody.innerHTML = "";
			pageData.data.forEach((ojt) => {
				const status_text = ojt.ojt.statusName.slice(4, ojt.ojt.statusName.length);
				console.log("Status text: " + status_text);
			    const tr = document.createElement("tr");
			    tr.innerHTML = `
			      <td class="border-0 py-3 px-4">
			        <div class="d-flex align-items-center">
			          <div>
			            <h6 class="fw-semibold mb-0">${ojt.ojt.name}</h6>
			            <small class="text-muted">${ojt.ojt.email}</small>
			          </div>
			        </div>
			      </td>
			      <td class="border-0 py-3">${ojt.ojt.batchName}</td>
			      <td class="border-0 py-3">${ojt.attendance}%</td>
			      <td class="border-0 py-3">
			        <span class="badge bg-primary" class="status">${status_text}</span>
			      </td>
			      <td class="border-0 py-3">
			        <div class="d-flex gap-1">
			          <a href="/admin/ojt-members/${ojt.ojt.id}" class="btn btn-outline-info btn-sm" title="View">
			            <i class="bi bi-eye"></i>
			          </a>
			          <a href="/admin/ojt-members/edit/${ojt.ojt.id}" class="btn btn-outline-warning btn-sm" title="Edit">
			            <i class="bi bi-pencil"></i>
			          </a>
			          <a href="/admin/ojt/delete/${ojt.ojt.id}" class="btn btn-outline-danger btn-sm" title="Delete">
			            <i class="bi bi-trash"></i>
			          </a>
			        </div>
			      </td>
			    `;
			    tbody.appendChild(tr);
			  });

			document.getElementById("totalEntries").innerText = pageData.totalElements;
			document.getElementById("startEntry").innerText = currentPage * pageSize + 1;
			document.getElementById("endEntry").innerText = Math.min((currentPage + 1) * pageSize, pageData.totalElements);
			for(let i = 0; i < pageData.data.length; i++) {
				const status_text = pageData.data[i].ojt.statusName;
				document.querySelectorAll(".status").innerText = status_text.slice(4, status_text.length);
			}
		}

		function renderPagination() {
			const pagination = document.getElementById("pagination");
			Array.from(pagination.querySelectorAll(".page-number")).forEach(el => el.remove());

			for (let i = 0; i < totalPages; i++) {
				const li = document.createElement("li");
				li.classList.add("page-item", "page-number");
				if (i === currentPage) li.classList.add("active");

				const a = document.createElement("a");
				a.classList.add("page-link");
				a.href = "#";
				a.innerText = i + 1;
				a.addEventListener("click", (e) => {
					e.preventDefault();
					if (i !== currentPage) {
						goToPage(i);
					}
				});

				li.appendChild(a);
				pagination.insertBefore(li, document.getElementById("nextPage"));
			}

			document.getElementById("prevPage").classList.toggle("disabled", currentPage === 0);
			document.getElementById("nextPage").classList.toggle("disabled", currentPage === totalPages - 1);
		}

		async function goToPage(page) {
			if (page < 0 || page >= totalPages) return;
			currentPage = page;
			try {
				const pageData = await fetchPage(page);
				totalPages = pageData.totalPages;
				renderTable(pageData);
				renderPagination();
			} catch (err) {
				console.error(err);
				alert("Failed to load data.");
			}
		}

		document.getElementById("prevPage").addEventListener("click", (e) => {
			e.preventDefault();
			if (currentPage > 0) goToPage(currentPage - 1);
		});

		document.getElementById("nextPage").addEventListener("click", (e) => {
			e.preventDefault();
			if (currentPage < totalPages - 1) goToPage(currentPage + 1);
		});

		window.onload = () => {
			goToPage(0);
		};
	</script>
</body>

</html>